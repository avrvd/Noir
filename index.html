<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Noir</title>
<style>
  /* Reset */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: #CCC;
  }
  body {
    background: #0D0D0D;
    display: flex; flex-direction: column; min-height: 100vh;
    padding: 20px;
  }
  header {
    text-align: center;
    margin-bottom: 25px;
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: 3px;
    color: #1E90FF;
    user-select: none;
  }
  #timer {
    font-size: 4rem;
    text-align: center;
    margin-bottom: 15px;
    font-variant-numeric: tabular-nums;
    user-select: none;
  }
  #distance, #speed {
    text-align: center;
    font-size: 1.2rem;
    color: #7BA7CC;
    margin-bottom: 10px;
    user-select: none;
  }
  #controls {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
  }
  button {
    background: #1E90FF;
    border: none;
    border-radius: 8px;
    padding: 14px 32px;
    color: #EEE;
    font-size: 1.2rem;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.15s ease;
    user-select: none;
  }
  button:active {
    transform: scale(0.95);
    background-color: #1667C3;
  }
  button:disabled {
    background-color: #37474F;
    cursor: not-allowed;
  }
  #history {
    flex-grow: 1;
    overflow-y: auto;
    max-height: 250px;
    border-top: 1px solid #37474F;
    padding-top: 15px;
    color: #999;
    font-size: 1rem;
  }
  #history h2 {
    color: #1E90FF;
    margin-bottom: 10px;
  }
  .entry {
    padding: 8px 12px;
    border-radius: 6px;
    background: #121212;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
  }
  .entry span {
    user-select: text;
  }
  #clearHistory {
    background: #CC3333;
    margin-top: 12px;
  }
  #clearHistory:active {
    background-color: #992222;
  }
  footer {
    text-align: center;
    padding: 12px 0 6px;
    font-size: 0.9rem;
    color: #444;
    user-select: none;
  }
</style>
</head>
<body>
<header>Noir</header>
<div style="text-align: center; margin-bottom: 10px;">
  <button id="langToggle" style="padding: 8px 16px; background: #555; color: white; border-radius: 6px; border: none; cursor: pointer;">
    English
  </button>
</div>


<div id="timer">00:00:00</div>
<div id="distance">فاصله: 0.00 کیلومتر</div>
<div id="speed">سرعت متوسط: 0.00 کیلومتر/ساعت</div>

<div id="controls">
  <button id="startBtn">شروع</button>
  <button id="stopBtn" disabled>توقف</button>
</div>

<section id="history">
  <h2>تاریخچه پیاده‌روی</h2>
  <div id="entries"></div>
  <button id="clearHistory">پاک کردن تاریخچه</button>
</section>

<footer>© 2025 Noir by آراد</footer>

<script>
(() => {
  const timerEl = document.getElementById('timer');
  const distanceEl = document.getElementById('distance');
  const speedEl = document.getElementById('speed');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const entriesEl = document.getElementById('entries');
  const clearBtn = document.getElementById('clearHistory');

  let watchId = null;
  let positions = [];
  let startTime = null;
  let timerInterval = null;

  function formatTime(ms) {
    let totalSeconds = Math.floor(ms / 1000);
    let hours = Math.floor(totalSeconds / 3600);
    let mins = Math.floor((totalSeconds % 3600) / 60);
    let secs = totalSeconds % 60;
    return `${String(hours).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  }

  // Haversine formula to calculate distance between two lat/lng coords in meters
  function haversine(lat1, lon1, lat2, lon2) {
    function toRad(x) { return x * Math.PI / 180; }
    const R = 6371000; // meters
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function calculateDistance(coords) {
    let dist = 0;
    for (let i = 1; i < coords.length; i++) {
      dist += haversine(
        coords[i-1].latitude, coords[i-1].longitude,
        coords[i].latitude, coords[i].longitude
      );
    }
    return dist / 1000; // kilometers
  }

  function updateTimer() {
    if (!startTime) return;
    const elapsed = Date.now() - startTime;
    timerEl.textContent = formatTime(elapsed);
  }

  function loadHistory() {
    const data = localStorage.getItem('noirWalkHistory');
    if (!data) return [];
    try {
      return JSON.parse(data);
    } catch {
      return [];
    }
  }

  function saveHistory(history) {
    localStorage.setItem('noirWalkHistory', JSON.stringify(history));
  }

  function renderHistory() {
    const history = loadHistory();
    entriesEl.innerHTML = '';
    if (history.length === 0) {
      entriesEl.textContent = 'هیچ رکوردی ثبت نشده.';
      return;
    }
    history.forEach(entry => {
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `
        <span>${entry.date}</span>
        <span>زمان: ${entry.time} | فاصله: ${entry.distance} کیلومتر | سرعت: ${entry.speed} کیلومتر/ساعت</span>
      `;
      entriesEl.appendChild(div);
    });
  }

  function clearHistory() {
    localStorage.removeItem('noirWalkHistory');
    renderHistory();
  }

  function startTracking() {
    if (!navigator.geolocation) {
      alert('جی‌پی‌اس پشتیبانی نمی‌شود.');
      return;
    }
    positions = [];
    startTime = Date.now();
    timerEl.textContent = '00:00:00';
    distanceEl.textContent = 'فاصله: 0.00 کیلومتر';
    speedEl.textContent = 'سرعت متوسط: 0.00 کیلومتر/ساعت';

    startBtn.disabled = true;
    stopBtn.disabled = false;

    watchId = navigator.geolocation.watchPosition(
      pos => {
        positions.push(pos.coords);
        const dist = calculateDistance(positions);
        distanceEl.textContent = `فاصله: ${dist.toFixed(2)} کیلومتر`;
        const elapsedH = (Date.now() - startTime) / (1000 * 3600);
        speedEl.textContent = elapsedH > 0 ? `سرعت متوسط: ${(dist / elapsedH).toFixed(2)} کیلومتر/ساعت` : 'سرعت متوسط: 0.00 کیلومتر/ساعت';
      },
      err => {
        alert('خطا در دریافت موقعیت: ' + err.message);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000
      }
    );

    timerInterval = setInterval(updateTimer, 1000);
  }

  function stopTracking() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    const elapsedMs = Date.now() - startTime;
    const elapsedTime = formatTime(elapsedMs);
    const dist = calculateDistance(positions);
    const elapsedH = elapsedMs / (1000 * 3600);
    const avgSpeed = elapsedH > 0 ? (dist / elapsedH).toFixed(2) : '0.00';

    // Save to history
    const history = loadHistory();
    const dateStr = new Date().toLocaleString('fa-IR');
    history.unshift({
      date: dateStr,
      time: elapsedTime,
      distance: dist.toFixed(2),
      speed: avgSpeed
    });
    saveHistory(history);
    renderHistory();

    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  startBtn.addEventListener('click', startTracking);
  stopBtn.addEventListener('click', stopTracking);
  clearBtn.addEventListener('click', clearHistory);

  // Initial render of history on page load
  renderHistory();
})();
</script>

<script>
  const langData = {
    fa: {
      start: "شروع",
      stop: "توقف",
      distance: "فاصله",
      speed: "سرعت متوسط",
      history: "تاریخچه پیاده‌روی",
      noRecords: "هیچ رکوردی ثبت نشده.",
      clear: "پاک کردن تاریخچه",
      time: "زمان",
      km: "کیلومتر",
      kmh: "کیلومتر/ساعت"
    },
    en: {
      start: "Start",
      stop: "Stop",
      distance: "Distance",
      speed: "Avg. Speed",
      history: "Walk History",
      noRecords: "No records found.",
      clear: "Clear History",
      time: "Time",
      km: "km",
      kmh: "km/h"
    }
  };

  let currentLang = "fa";

  document.getElementById("langToggle").addEventListener("click", () => {
    currentLang = currentLang === "fa" ? "en" : "fa";
    const t = langData[currentLang];

    document.getElementById("startBtn").textContent = t.start;
    document.getElementById("stopBtn").textContent = t.stop;
    document.getElementById("distance").textContent = `${t.distance}: 0.00 ${t.km}`;
    document.getElementById("speed").textContent = `${t.speed}: 0.00 ${t.kmh}`;
    document.querySelector("#history h2").textContent = t.history;
    document.getElementById("clearHistory").textContent = t.clear;
    document.getElementById("langToggle").textContent = currentLang === "fa" ? "English" : "فارسی";

    const entries = JSON.parse(localStorage.getItem('noirWalkHistory') || "[]");
    const entriesEl = document.getElementById("entries");
    entriesEl.innerHTML = "";

    if (entries.length === 0) {
      entriesEl.textContent = t.noRecords;
    } else {
      entries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `
          <span>${entry.date}</span>
          <span>${t.time}: ${entry.time} | ${t.distance}: ${entry.distance} ${t.km} | ${t.speed}: ${entry.speed} ${t.kmh}</span>
        `;
        entriesEl.appendChild(div);
      });
    }
  });
</script>

</body>
</html>